<!--------------------------------------------------------->
    <h1 class="w3-text-teal">Timelines</h1>
<!--------------------------------------------------------->

<h4 class="w3-text-teal">
This module introduces timelines.
A timeline is a graphical representation of a sequence of state
transitions.
</h4>


<p>
We call a state transition of an agent an
<i>event</i> at that agent.  The graph of a trajectory is an acyclic
    labeled directed graph in which each vertex represents an event,
and the edges are as follows:
<ul>
  <li>
  <i>Agent timeline edges</i>:
  There is an edge directed from an
    event at an agent to the next event at that agent; the edge is
  labeled with the state of the agent between the two events.
  </li>
  <li>
  <i>Message edges</i>
  A message \(m\) sent at an event \(e\) and received at an event
    \(e'\) is represented by an edge directed from \(e\) to \(e'\),
  and the edge is labeled \(m\).
  </li>
</ul>

<p>
The graph is acyclic because each edge is directed from an event
towards a later event.

A <i>system timeline</i> of a trajectory is a graph of the trajectory where
the graph is laid out in the following way.
The horizontal axis represents time.  

<p>
The events in the timeline are placed in the order in which they occur,
with events appearing earlier in the trajectory appearing earlier in
the timeline (i.e. towards the left).
For convenience, the initial state is represented by a set of initial events,
one for each agent, and these initial events are shown at the same
instant (same vertical line).

<p>
Each agent has its own timeline
represented by a horizontal line with all events
of the same agent on the same horizontal line. An edge from an event at an
agent to the next event at that agent is shown horizontally, directed
from left to right.

<h4 style="color:red;">Example</h4>
<figure>
    <img src="Timelines/Timelines.001.jpeg" alt="Fig1" style="width:100%">
    <figcaption>Fig.1: A System Timeline</figcaption>
</figure>
This example shows a system timeline with two agents, \(A\) and
\(B\).  The vertices  A0, A1, A2, A3 represent events at agent \(A\);
likewise vertices B0, B1 B2,represent \(B\)'s events.

<p>
An edge along an agent's timeline is labeled with the state of that
agent at the point. For example, the edge from event A1 to event A2 is
labeled \(S[A1]\) which is agent \(A\)'s state after event A1 and
before event A2.

<p>
Event A1 is an example of an internal event in which an agent changes
state without receiving a message.
Event A2 is an example of an event in which an agent changes
state when it receives a message.

<p>
The diagram shows that
agent \(A\) sends message \(m_{0}\) in event A1 and this message is
received by agent \(B\) in event B1.

<h4 class="w3-text-teal">Channel States in System Timelines</h4>
The state of a channel \(c\) at time \(T\) is the sequence (in time
order) of messages that are sent along \(c\) before \(T\) and that are
received after \(T\). The state of \(c\) at \(T\) can be obtained from
the system timeline as the sequence of labels of edges representing
messages along \(c\) that are cut by the \(T\)-line, the vertical line
at \(T\).

<h4 style="color:red;">Example</h4>
<figure>
    <img src="Timelines/Timelines.002.jpeg" alt="Fig2" style="width:100%">
    <figcaption>Fig.2: Global State from a System Timeline</figcaption>
</figure>
Figure 2 shows a system
timeline with agents \(A, B, D\). Agent \(A\) sends messages
\(m_{0}\) along a channel \(x\) and sends \(m_{1}\) along a different
channel \(c\) at event A1.  When agent \(D\) receives \(m_{0}\) at
event D1 it sends message \(r_{0}\) to \(A\) along a channel \(y\).
When agent \(A\) receives \(r_{0}\) at event A2 it sends message
\(m_{2}\) to \(B\) along channel \(c\).  When agent \(B\) receives
message \(m_{1}\) at event B1 it sends message message \(u_{0}\) to
\(A\) along a channel \(v\).

<p>
The state of \(c\) at time \(T\) is the sequence of labels, \([m_{1},
m_{2}]\), of edges representing messages on \(c\) that are cut by the
\(T\)-line.  The state of an agent \(A\) at \(T\) is the label of the
edge on \(A\)'s timeline cut by the \(T\)-line.  So, the global state
of the system at T can be obtained from labels of edges cut by the
\(T\)-line.


<h4 class="w3-text-teal">Sequence of Global States</h4>
The sequence of <i>global</i> states in a trajectory can be 
obtained from the system timeline from the labels of edges cut by the
sequence of vertical lines before each event.
The starting and ending states of the trajectory are obtained from the
earliest (leftmost) and latest (rightmost) vertical
lines in the diagram.

<h4 style="color:red;">Example</h4>
<figure>
    <img src="Timelines/Timelines.003.jpeg" alt="Fig3" style="width:100%">
    <figcaption>Fig.3: Global States in the Trajectory</figcaption>
</figure>


<h4 class="w3-text-teal">Different Trajectories with Identical Graphs</h4>
Are there different trajectories with identical graphs?
Look at the next figure.

<figure>
    <img src="Timelines/Timelines.005.jpeg" alt="Fig5" style="width:100%">
    <figcaption>Fig.4: A Different Trajectory with Same Graph</figcaption>
</figure>
The trajectory in this diagram is specified by the sequence of events:
Initial events (A0, B0, D0) followed by the sequence A1, D1, B1,
A2, A3, B2.

<p>
The graphs of figures 3 and 4 are the same but the trajectories that
the figures represent are different.  In figure 4 event B1 occurs
before event A2 whereas in figure 3, B1 occurs after A2.  So, the
global state after B1 and before A2 in figure 4 is never
visited in figure 3;
However, figures 3 and 4 have the same starting and ending states.
The following theorem captures the idea illustrated by figures 3 and
4.


<h4 class="w3-text-teal">Theorem about Permutation of Event Sequences</h4>

<hr class="new2">
    <h5 style="color:blue;">
Let \(X\) be a trajectory of a system. Any permutation \(Y\)
of the sequence of events in \(X\), where agents have the same
timelines in \(X\) and \(Y\),
is also a trajectory of the system
if:
<br>
<i>a message is received only after it is sent in \(Y\).</i>
</h5>
<hr class="new2">

The conditions imply that the graph of \(Y\) is the same
as that of \(X\), and all edges in \(Y\) are <i>directed forwards in
time.</i>

<p>
The theorem is illustrated with \(X, Y\) as the
system timelines in figures 3 and 4.


<h4 class="w3-text-teal">Proof</h4>
The theorem holds trivially if \(X\) and \(Y\) are identical. If \(X\)
and \(Y\) are different then there exists a pair of consecutive events
\(e\) and \(e'\) in \(X\) where  \(e'\) appears after \(e\) in \(X\)
but \(e'\) appears before \(e\) in \(Y\). Let \(Z\) be the
trajectory obtained by flipping the order of \(e\) and \(e'\) in
\(X\).
We will prove that \(Z\) is also a trajectory. The diagram to the left
in the figure below shows the events before their order is switched, while
the diagram to the right shows the events after their order is switched.

<figure>
    <img src="Timelines/Timelines.006.jpeg" alt="Fig5" style="width:100%">
    <figcaption>Fig.5: Switching order of consecutive independent events</figcaption>
</figure>

<p>
Let \(e\) be at an
agent \(A\) and \(e'\) be at an agent \(B\). From condition 1, agents
\(A\) and \(B\) are different.
Therefore, the state of \(A\) immediately before \(e\) and the state
of \(B\) immediately before \(e'\) are independent of the order of the
events. 
<p>
Because of condition 2, the message (if any) received in \(e'\) is
sent before \(e\), and the message (if any) sent in \(e\) is
received after \(e'\).
Therefore messages received in events \(e\) and
\(e'\) are independent of their order.
<p>
The messages received and the states of the agents before the
events are independent of the order of events.
So the messages sent and the states of the agents after the
events are independent of the order of events. Therefore \(Z\) is also
a trajectory. 

<p>
\(Z\) is closer to \(Y\) than \(X\) where the measure of closeness is
the number of out-of-order pairs of events. The proof follows by repeatedly
flipping out-of-order adjacent pairs until \(Y\) is obtained.

<!--------------------------------------------------------->
<h2 class="w3-text-teal">Constructing System Timelines from Agent Timelines</h2>
<!--------------------------------------------------------->
Let's look at the problem of reconstructing a log of events of the
global system (i.e. the system timeline) given logs each agent's own
events (i.e. agent timelines).


<h4 style="color:red;">Example</h4>
The figure below shows timelines of each of the three agents in the example
given in the Timelines module.
<figure>
    <img src="Timelines/Timelines.015.jpeg" alt="Fig1" style="width:100%">
    <figcaption>Fig.6: Agent Timelines</figcaption>
</figure>

Given these agent timelines what sequence of events occurred?

<p>
We don't know what happened. This is because <i>any</i> system timeline,
with these agent timelines <str>could</str> have happened provided
<i>each message is received only after it is sent.</i>

<p>
In
our example, the system timelines
of figures 3 and 4 could have occurred given the agent timelines of
figure 6. For convenience these system timelines are shown again
below.
<figure>
    <img src="Timelines/Timelines.016.jpeg" alt="Fig1" style="width:100%">
    <figcaption>Fig.7: System Timelines with identical Agent Timelines</figcaption>
</figure>




<h3 class="w3-text-teal">Cuts of System Timelines</h3>
A cut of a a system timeline is a partition of the events in
the timeline into two subsets called <i>past</i> and <i>future</i>.


<hr class="new2">
    <h5 style="color:blue;">
A <i>consistent cut</i> is one
in which there is no edge in the graph from a <i>future</i> event
to a <i>past</i> event.
</h5>
<hr class="new2">


<p class="w3-text-teal">Equivalent Definitions of Consistent Cuts</p>
<p>The following are equivalent definitions of a consistent cut:
<ol>
  <li>
  All edges <i>to past</i> events are <i>from past</i> events.
  </li>
  <li>
  All edges <i>from future</i> events are <i>to future</i> events.
  </li>
</ol>
  

<h4 style="color:red;">Example</h4>
The figure below shows cuts across two system timelines
where past events are colored black and future events are green.
<figure>
    <img src="Timelines/Timelines.010.jpeg" alt="Fig6" style="width:100%">
    <figcaption>Fig.6: Cuts of Timelines</figcaption>
</figure>

The cuts in both diagrams are identical: past events are A0, A1, B0,
D0, D1. 
The cuts are consistent because there is no edge from
green to black.
<p>
A purple vertical line, representing an instant in time, separates past from
future in the lower diagram.
By contrast, a curved line separates past from future in the upper
diagram. There is no vertical line that separates past from future in
the upper diagram because a past event (B1) appears after a future
event (A2).

<p class="w3-text-teal">Intuition for Permuting Past before Future</p>
Given the upper diagram, in which past and future are separated by a
curved line,
we can use the following intuitive method to obtain the trajectory of the lower
diagram in which past and future are separated by a vertical line.

<p>
Treat the purple curved separating line in the upper diagram as a
string, and pull the string taut. Doing so may push some events, such as
A2, to the right, and other events, such as B1, to the left.
As events move, while the string is tautened, all edges always remain
directed from past to future. This is because there is no edge that
crosses the string from the right to the left. Therefore the
conditions of the theorem are always satisfied.

<h3 class="w3-text-teal">Theorem about Consistent Cuts</h3>
<hr class="new2">
    <h5 style="color:blue;">
For any consistent cut, \([past, future]\), of a system timeline \(X\)
there exists a system timeline \(Y\) in which the sequence of events is a
permuation of of the sequence of events in \(X\), and
where <i>all \(past\) events occur <str>before</str> all
\(future\) events</i>.
</h5>
<hr class="new2">
<p>
The proof follows directly from the theorem on the permutation of
event sequences.
We create a system  timeline \(Y\) with the same agent
timelines as system timeline \(X\).
The theorem tells us that \(Y\)
also represents a trajectory if the event timelines are the same in
\(X\) and \(Y\) and <i>each message is received only
after it is sent</i> in \(Y\).
We can create a system timeline \(Y\) in which all \(past\) events occur
before all \(future\) events because there are no messages from
\(future\) to \(past\).
<p>
We permute events to get \(Y\) as follows: if there is a pair of adjacent events
in which a \(future\) event occurs before the \(past\) event
then flip the order of this pair of events. The theorem on the permutation of
event sequences says that the sequence of events
after flipping the order of events is also a valid timeline because
there is no message from a \(future\) event to a \(past\) event in a
consistent cut. Repeatedly flip out-of-order adjacent events until all 
\(future\) events occur after all \(past\) events.

<h4 style="color:red;">Example</h4>
The cut in the diagram on the top of figure 5 is consistent.
Therefore, there exists a system timeline diagram, shown at the bottom of the
figure, in which all past events occur before all
future events.


<h4 class="w3-text-teal">Corollary: Trajectory from Initial to Snapshot to Final State</h4>
Consider an algorithm that computes the state at a consistent
cut. Let \(s_{init}\) and \(s_{fini}\) be the states in which the
algorithm starts and finishes (respectively), and let \(s_{snap}\) be
the state at the consistent cut.
<hr class="new2">
<h5 style="color:blue;">
There exists a trajectory from
\(s_{init}\) that visits \(s_{snap}\) and later visits \(s_{fini}\).
</h5>
<hr class="new2">

<p>
For example, an algorithm in the top diagram of figure 5 determines
the global state \(s_{snap}\) along the curved consistent cut during a
trajectory. Let \(s_{init}\) and \(s_{fini}\) be the states before the
algorithm starts and after it finishes, i.e. at the left and
right-hand ends of the system timeline diagram. Then, the diagram in the
lower diagram of figure 5 also represents a trajectory 
from \(s_{init}\) to \(s_{snap}\) and then to \(s_{fini}\).


<h4 class="w3-text-teal">Takeaway</h4>
Timelines are a familiar concept, helpful in
understanding distributed systems and other multi-agent
systems.

<h4 style="color:blue;">Review</h4>
<ol>
  <li>What is timeline? Why is the graph of a timeline acyclic?</li>
  <li>How is the state of a channel determined from the system timeline?</li>
  <li>
  Let \(X\) be a system timeline of a trajectory of a system. Let
  \(Y\) be a system timeline with the same graph. Show that \(Y\) is
  also a system timeline if and only if all edges in
  \(Y\) are directed forward in time.
  </li>
  <li>
  What is a cut in a timeline? Draw a system timeline and give
  examples of consistent and inconsistent cuts. Given a system timeline
  and a consistent cut, draw a system timeline with the same
  graph, but in which past events occur before future events.
</ol>.