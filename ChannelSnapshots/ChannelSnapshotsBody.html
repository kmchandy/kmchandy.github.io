

    <!--------------------------------------------------------->
    <h2 class="w3-text-teal">Snapshots of Distributed Systems</h2>

    <!--------------------------------------------------------->
The snapshot algorithm determines the global state of a system at a
<a href=
"../FoundationsOfDistributedSystems/DistributedSystemsIntroduction/Timelines.html">
consistent cut of a timeline diagram.</a>

<h4 class="w3-text-teal">Brief Review of Consistent Cuts</h4>
A consistent cut of a timeline diagram is a partition of the events in
the diagram into two subsets called <i>past</i> and <i>future</i>, and
in which there is no message from a future event
to a past event.

<h4 style="color:red;">Review: Examples of Cuts</h4>
<figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.001.jpeg"
alt="Fig1" style="width:80%"> 
    <figcaption>Fig.1: A consistent cut</figcaption>
</figure>
Figure 1 shows a consistent cut, and figure 2 shows an inconsistent one.

<figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.002.jpeg" alt="Fig2" style="width:80%">
    <figcaption>Fig.2: An inconsistent cut</figcaption>
</figure>

    <p>
    We use the phrase "an agent B takes its local snapshot" for "an
agent B records B's state."
A key question is <i>when</i> should an agent take
its own local snapshot to ensure that the collection of local
snapshots form a consistent cut? 

<h4 style="color:red;">Examples of Local Snapshots</h4>
In the next two figures, the points at which each agent takes its
local snapshot are shown as yellow circles. Past events are those
earlier than the points at which agents take their local
snapshots. Figure 3 shows agent snapshot points corresponding to a
consistent cut, and figure 4 shows inconsistent snapshot points. 
<figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.003.jpeg"
alt="Fig3" style="width:80%"> 
    <figcaption>Fig.3: Consistent Local Snapshots</figcaption>
</figure>
<figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.004.jpeg" alt="Fig4" style="width:80%">
    <figcaption>Fig.4: Inconsistent Local Snapshots</figcaption>
</figure>
What algorithm allows local snapshots such as those in figure 3, but not
those in figure 4?

    <h3 class="w3-text-teal">Global snapshot algorithm</h3>
The algorithm employs a special kind of message called a <i>marker</i>
which is distinct from all other messages in the system.
Each agent takes its local snapshot exactly once and exactly one
marker is sent along each channel.

<p>
The steps are:
<ol>
  <li>
  The algorithm begins by one or more agents taking their local snapshots.
  </li>
  <li>
  When an agent takes its local snapshot it sends a <i>marker</i> on each
  of its outgoing channels.
  </li>
  <li>
  When an agent receives a marker, the agent takes its local snapshot
  if it has not already done so.
  </li>
</ol>
We assume that there is a path of directed channels from each agent to every
other agent so that all agents receive markers eventually.

<h3 style="color:red;">Example</h3>
Figure 5 illustrates the algorithm. In this example, there is exactly one channel
between from each agent to each different agent. When B takes its
snapshot it sends markers
to A and C. Markers are shown as green edges.
Agent C takes its snapshot when it receives the marker
which ensures that C's snapshot is before event 11.

    <figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.005.jpeg" alt="Fig5" style="width:80%">
    <figcaption>Fig.5: Markers ensure cuts are consistent</figcaption>
</figure>
When agents B and C receive markers they take their snapshots if they
    haven't done so already, and send markers in their turn. These
markers are shown in the next figure.



    <figure>
    <img src="ChannelSnapshots_Figures/ChannelSnapshots_Figures.006.jpeg" alt="Fig6" style="width:80%">
    <figcaption>Fig.6: Showing all Markers</figcaption>

<h4 class="w3-text-teal">Proof of correctness</h4>
The points at which agents take their snapshots form a cut where
events on an agent's timeline before the agent takes its snapshot are
past events.  A cut is consistent exactly when all messages sent in
the future are received in the future.
<p>
Let \(m\) be a message sent in a future event. We will prove that
\(m\) is received in a future event.

<p>
Because \(m\) is sent in a future event, \(m\) is sent after the
sender takes its snapshot.  When an agent takes its snapshot it sends
markers on all its outgoing channels.  So, \(m\) is sent along a
channel after the sender sends a marker on that channel.

<p>
Channels are first-in-first-out.  So the receiver gets \(m\) after
receiving a marker.  And so the receiver gets \(m\) after the receiver
takes its snapshot.  Events after an agent takes its snapshot are
future events.  Therefore \(m\) is received in the future.

<h3 class="w3-text-teal">Snapshots of Channels</h3>
Next we look at how the algorithm records snapshots of channels.  From
the timeline theorem, the sequence of messages in the channel in a
global snapshot are the messages sent on the channel in the past and
received on the channel in the future.

<p>
Messages sent in the past are messages sent before the sender takes
its snapshot.  Messages received in the future are messages received
after the receiver takes its snapshot.  So, the messages in the
channel in a snapshot are the messages sent before the sender takes
its snapshot and received after the receiver takes its snapshot.

<p>
When an agent takes its local snapshot it sends a marker on each of
its outgoing channels.  So, messages sent along a channel in the past
are messages sent before a marker is sent along that channel.

<p>
Because channels are first-in-first-out, messages sent along a channel
in the past are messages received along the channel before a marker is
received along that channel. Therefore, the messages in a channel in
a snapshot are the messages that the receiver receives along the
channel after the receiver takes its local snapshot and before the
receiver receives a marker on that channel.

<h4 class="w3-text-teal">Algorithm to Record Channel States</h4>
Let \(c\) be a channel, and let \(c\) be directed towards an agent
\(B\).
The snapshot of \(c\) is determined by \(B\) as the sequence of
messages that \(B\) receives after \(B\) takes its local snapshot and
before \(B\) gets a marker along \(c\).

<p>
Note: If \(B\) takes its local snapshot when it receives a marker
along \(c\), then the snapshot of \(c\) is the empty sequence.

<h3 style="color:red;">Example: Channel Snapshot</h3>
A diagram that illustrates the process by which an agent gets a
snapshot of an incoming channel is shown below. The diagram shows the
timelines for two agents, \(A\) and \(B\).

<p>
Agent \(A\) sends messages \(m_{0}, m_{1}, m_{2}\), then sends a
marker (colored green), and then message \(m_{3}\), to agent \(B\) on a
channel \(x\). All the messages in the diagram are sent on the same
channel.

<p>
The events shown as blue circles on \(A\)'s timeline are
events in which \(A\) sends messages \(m_{0}, m_{1}, m_{2}\) before
\(A\) takes its local snapshot.  The event shown as a black circle
shows \(A\) sending messages \(m_{3}\) after \(A\) takes its local
snapshot. The point at which \(A\) takes its local snapshot is the
point at which the purple wavy line (the cut) crosses \(A\)'s timeline.

    <figure>
    <img src="ChannelSnapshots_3.jpg" alt="Fig3" style="width:100%">
    <figcaption>Fig.3: Snapshot of a channel</figcaption>
    </figure>

The event shown as a yellow circle on \(B\)'s timeline represents the
event in which \(B\) receives messages \(m_{0}\) before \(B\) takes its
own snapshot. The events shown as organge circles represent events in
which \(B\) receives messages \(m_{1}, m_{2}\) after \(B\) takes its
own snapshot and before \(B\) receives the marker. The black event
represents \(B\) receiving message \(m_{3}\) after \(B\) takes its
snapshot.

<p>
The messages that \(A\) sent in the past are \(m_{0}, m_{1}, m_{2}\).
The messages that \(B\) receives in the future are \(m_{1}, m_{2},
m_{3}, \ldots\).
The state of the channel, at the cut, is the sequence of messages \([m_{1},
m_{2}]\) that \(A\) sent in the past and that \(B\) receives in the
future.
This is shown as the sequence of red message lines that
cross the wavy purple line which represents the global snapshot.
These are the messages that \(B\) receives after it takes its local
snapshot and before it receives the marker.

<p class="w3-text-teal">Collecting Local Agent and Channel Snapshots</p>
Algorithms by which agents collect local snapshots of agents and
channels and then form global snapshots are presented later.
One of many applications of global snapshots is to checkpoint a
distributed computation so that the computation can be restarted from
the checkpoint if a transient event occurs.
